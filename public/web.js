
const API = {}; API.base="/.netlify/functions";
function saveToken(t){ localStorage.setItem('token', t); }
function getToken(){ return localStorage.getItem('token'); }
function clearToken(){ localStorage.removeItem('token'); }
function authHeader(){ const t=getToken(); return t? {'Authorization':'Bearer '+t} : {}; }
async function apiPost(path, body, auth=false){ const headers={'Content-Type':'application/json'}; if(auth) Object.assign(headers, authHeader()); const res = await fetch(API.base+path,{method:'POST', headers, body: JSON.stringify(body)}); if(!res.ok) throw new Error(await res.text()); return res.json(); }
async function apiGet(path, auth=false){ const headers=auth?authHeader():{}; const res = await fetch(API.base+path,{headers}); if(!res.ok) throw new Error(await res.text()); return res.json(); }
function currentPage(){ return location.pathname.split('/').pop() || 'index.html'; }
document.addEventListener('DOMContentLoaded', ()=>{ const p=currentPage(); if(p==='auth.html') initAuth(); if(p==='new-listing.html') initNewListing(); if(p==='listings.html') initListings(); if(p==='dashboard.html') initDashboard(); if(p==='admin.html') initAdmin(); if(p==='home.html') initHome(); });
function initAuth(){ const reg=document.getElementById('formRegister'); const log=document.getElementById('formLogin');
  reg?.addEventListener('submit', async (e)=>{ e.preventDefault(); const fd=new FormData(reg); try{ await apiPost('/register', Object.fromEntries(fd.entries())); document.getElementById('regMsg').textContent='Compte créé. Connectez-vous.';}catch(err){ document.getElementById('regMsg').textContent=err.message; } });
  log?.addEventListener('submit', async (e)=>{ e.preventDefault(); const fd=new FormData(log); try{ const out=await apiPost('/login', Object.fromEntries(fd.entries())); saveToken(out.token); location.href='/home.html'; }catch(err){ document.getElementById('loginMsg').textContent=err.message; } });
}
function readFilesAsDataURLs(input, max=3){ return new Promise((resolve)=>{ const files=[...input.files].slice(0,max); if(files.length===0) return resolve([]); let out=[]; let i=0; files.forEach(f=>{ const r=new FileReader(); r.onload=()=>{ out.push(r.result); if(++i===files.length) resolve(out); }; r.readAsDataURL(f); }); }); }
function initNewListing(){ const form=document.getElementById('formNewListing'); const photoInput=document.getElementById('photoInput');
  form?.addEventListener('submit', async (e)=>{ e.preventDefault(); const fd=new FormData(form); const obj=Object.fromEntries(fd.entries()); obj.options = fd.getAll('options'); obj.photos = await readFilesAsDataURLs(photoInput,3);
    try{ await apiPost('/create_listing', obj, true); document.getElementById('newListingMsg').textContent='Annonce publiée.'; form.reset(); }catch(err){ document.getElementById('newListingMsg').textContent=err.message; }
  });
}
async function renderListings(list, root){ root.innerHTML=''; list.forEach(x=>{ const el=document.createElement('div'); el.className='card';
  const title = x.title || [x.brand, x.model, x.year].filter(Boolean).join(' ');
  const price = x.type.includes('vehicule') ? (x.type.includes('location') ? (x.price? x.price+' €/semaine':'' ) : (x.price? x.price+' €':'')) : (x.price? x.price+' €/mois':'');
  const mapSrc = `https://www.google.com/maps?q=${encodeURIComponent(x.city + ' ' + (x.postal_code||''))}&output=embed`;
  const badges=(x.options||[]).map(o=>`<span class='badge'>${o}</span>`).join('');
  const imgs = (x.photos||[]).map((u,i)=>`<img src='${u}' style='display:${i===0?'block':'none'}'>`).join('');
  const dots=(x.photos||[]).map((_,i)=>`<span class='dot ${i===0?'active':''}' data-i='${i}'></span>`).join('');
  el.innerHTML = `<div class='carousel'>${imgs}<div class='dots'>${dots}</div></div><h3>${title}</h3><div class='small'>${x.city}, ${x.postal_code||''}</div><div class='badges'>${badges}</div><div class='small'>${price}</div><div class='map'><iframe width='100%' height='180' style='border:0' loading='lazy' src='${mapSrc}'></iframe></div><div style='margin-top:10px'><button class='btn btn-int' data-id='${x.id}'>Je suis intéressé</button></div>`;
  root.appendChild(el);
  const images=el.querySelectorAll('.carousel img'); const dts=el.querySelectorAll('.dot'); dts.forEach(dot=>{ dot.addEventListener('click', ()=>{ const i=+dot.dataset.i; images.forEach((im,idx)=>im.style.display = idx===i?'block':'none'); dts.forEach(d=>d.classList.remove('active')); dot.classList.add('active'); }); });
}); root.querySelectorAll('.btn-int').forEach(btn=>{ btn.addEventListener('click', async ()=>{ try{ await apiPost('/interest', { listing_id: btn.dataset.id }, true); alert('Conversation créée. Consultez votre tableau de bord.'); }catch(err){ alert(err.message); } }); }); }
function initListings(){ const root=document.getElementById('listings'); const domSel=document.getElementById('filterDomain'); const typeSel=document.getElementById('filterType'); const search=document.getElementById('search');
  async function load(){ const data=await apiGet('/list_listings'); const d=domSel.value, t=typeSel.value, q=(search?.value||'').toLowerCase();
    const filtered=data.filter(x=>(!d||x.domaine===d) && (!t||x.type===t) && (!q || JSON.stringify(x).toLowerCase().includes(q))); renderListings(filtered, root); }
  domSel.addEventListener('change', load); typeSel.addEventListener('change', load); search?.addEventListener('input', load); load();
}
async function initDashboard(){ const info=document.getElementById('userInfo'); const myListings=document.getElementById('myListings'); const threads=document.getElementById('threads');
  try{ const me=await apiGet('/me', true); info.textContent=`Connecté en tant que ${me.firstName} ${me.lastName} (${me.email})`;
    const mine=await apiGet('/my_listings', true); myListings.innerHTML = mine.length? '' : '<div class="small">Aucune annonce.</div>'; mine.forEach(x=>{ const li=document.createElement('div'); li.className='list-item'; li.textContent=(x.title||x.brand||'Annonce')+' — '+(x.city||''); myListings.appendChild(li); });
    const th=await apiGet('/my_threads', true); threads.innerHTML = th.length? '' : '<div class="small">Aucune conversation.</div>'; th.forEach(t=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class='small'>Annonce: ${t.listing_title||t.listing_id}</div><div id='msg-${t.id}'></div><div class='row' style='margin-top:8px'><div><input class='input' id='input-${t.id}' placeholder='Votre message...'></div><div><button class='btn' id='send-${t.id}'>Envoyer</button></div></div>`; threads.appendChild(c); loadMessages(t.id); document.getElementById('send-'+t.id).addEventListener('click', async ()=>{ const v=document.getElementById('input-'+t.id).value.trim(); if(!v) return; await apiPost('/send_message', { thread_id:t.id, body:v }, true); document.getElementById('input-'+t.id).value=''; loadMessages(t.id); }); });
    document.getElementById('exportCsvBtn')?.addEventListener('click', async ()=>{ const blob = await apiGet('/export_listings_csv', true); const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(blob.csv); a.download='mes_annonces.csv'; a.click(); });
  }catch(e){ location.href='/auth.html'; }
}
async function loadMessages(threadId){ const box=document.getElementById('msg-'+threadId); const arr=await apiGet('/get_messages?thread_id='+encodeURIComponent(threadId), true); box.innerHTML = arr.map(m=>`<div class='small'><b>${m.sender_name}:</b> ${m.body} <span style='opacity:.6'>(${new Date(m.created_at).toLocaleString()})</span></div>`).join(''); }
async function initAdmin(){ const info=document.getElementById('adminInfo'); const list=document.getElementById('adminListings'); try{ const me=await apiGet('/me', true); const adm=await apiGet('/admin_check', true); info.textContent='Connecté : '+me.email+(adm.admin?' (ADMIN)':' (non admin)'); if(!adm.admin){ list.innerHTML='<div class="small">Accès réservé.</div>'; return; } const data=await apiGet('/list_listings'); list.innerHTML=''; data.forEach(x=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML = `<div><b>${x.title||x.brand||x.id}</b> — ${x.city||''} <span class='small'>(statut: ${x.status})</span></div><div class='small'>${x.domaine} / ${x.type}</div><div style='margin-top:8px'><button class='btn' data-act='actif' data-id='${x.id}'>Activer</button> <button class='btn' data-act='suspendu' data-id='${x.id}'>Suspendre</button> <button class='btn' data-act='supprimer' data-id='${x.id}'>Supprimer</button></div>`; list.appendChild(el); }); list.querySelectorAll('.btn').forEach(b=>{ b.addEventListener('click', async ()=>{ await apiPost('/admin_set_status', { id: b.dataset.id, status: b.dataset.act }, true); initAdmin(); }); }); }catch(e){ location.href='/auth.html'; }}
async function initHome(){ try{ const me=await apiGet('/me', true); document.getElementById('helloName').textContent = me.firstName || ''; document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ clearToken(); location.href='/'; }); const mine=await apiGet('/my_listings', true); document.getElementById('kpiListings').textContent = mine.length; const th=await apiGet('/my_threads', true); document.getElementById('kpiMsgs').textContent = th.length; const latest=await apiGet('/list_listings'); renderListings(latest.slice(0,6), document.getElementById('homeListings')); }catch(e){ location.href='/auth.html'; } }
